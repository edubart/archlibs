pkgname=libgit2
pkgver=20121108
pkgrel=1
pkgdesc="A linkable library for Git"
arch=('i686' 'x86_64')
url="http://libgit2.github.com/"
depends=('zlib' 'openssl')
makedepends=('cmake')
license=('GPL2')

_gitroot="https://github.com/libgit2/libgit2.git"
_gitname="libgit2"

build() {
    msg "Connecting to GIT server...."

    if [[ -d $_gitname ]] ; then
        cd "$_gitname" && git pull origin
        msg "The local files are updated."
    else
        git clone "$_gitroot"
    fi

    msg "GIT checkout done or server timeout"
    msg "Starting make..."

    rm -rf "$srcdir/$_gitname-build"
    git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
    cd "$srcdir/$_gitname-build"

    rm -fr build
    mkdir build && cd build

    cmake .. \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DBUILD_CLAR=OFF \
        -DBUILD_SHARED_LIBS=ON
    make
    cd ..

    rm -fr build2
    mkdir build2 && cd build2
    cmake .. \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DBUILD_CLAR=OFF \
        -DBUILD_SHARED_LIBS=OFF
    make
}

package() {
    make -C "$_gitname-build/build" DESTDIR="$pkgdir" install
    make -C "$_gitname-build/build2" DESTDIR="$pkgdir" install
}
