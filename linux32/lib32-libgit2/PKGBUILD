_pkgbasename=libgit2
pkgname=lib32-$_pkgbasename
pkgver=20121205
pkgrel=1
pkgdesc="A linkable library for Git"
arch=('i686' 'x86_64')
url="http://libgit2.github.com/"
depends=('zlib' 'openssl')
makedepends=('cmake')
license=('GPL2')

_gitroot="https://github.com/edubart/libgit2.git"
_gitname="libgit2"

build() {
    export CFLAGS="-march=i686 -m32 -fno-stack-protector"
    export CXXFLAGS="-march=i686 -m32 -fno-stack-protector"
    export LDFLAGS="-march=i686 -m32 -Wl,--as-needed"
    export PKG_CONFIG_PATH="/usr/lib32/pkgconfig"

    msg "Connecting to GIT server...."

    if [[ -d $_gitname ]] ; then
        cd "$_gitname" && git pull origin
        msg "The local files are updated."
    else
        git clone "$_gitroot"
    fi

    msg "GIT checkout done or server timeout"
    msg "Starting make..."

    rm -rf "$srcdir/$_gitname-build"
    git clone "$srcdir/$_gitname" "$srcdir/$_gitname-build"
    cd "$srcdir/$_gitname-build"

    rm -fr build
    mkdir build && cd build

    cmake .. \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DBUILD_CLAR=OFF \
        -DBUILD_SHARED_LIBS=ON
    make
    cd ..

    rm -fr build2
    mkdir build2 && cd build2
    cmake .. \
        -DCMAKE_BUILD_TYPE=Release \
        -DCMAKE_INSTALL_PREFIX=/usr \
        -DBUILD_CLAR=OFF \
        -DBUILD_SHARED_LIBS=OFF
    make
}

package() {
    make -C "$_gitname-build/build" DESTDIR="$pkgdir" install
    make -C "$_gitname-build/build2" DESTDIR="$pkgdir" install
    mv ${pkgdir}/usr/lib ${pkgdir}/usr/lib32
    rm -rf ${pkgdir}/usr/include
}
